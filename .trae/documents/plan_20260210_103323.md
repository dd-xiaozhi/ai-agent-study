# 彻底修复 AI 幻觉与上下文污染问题的计划

用户遇到的问题是 AI 在游戏过程中突然输出编程代码（C/Java/Swift）。这通常是由于上下文污染（Context Pollution）导致的：一条质量差的消息（如空消息或幻觉消息）进入了 Agent 的记忆，导致后续 Agent 参考该“噪音”并产生更严重的幻觉。

为了彻底解决这个问题，我将采取 **“阻断传播 + 强制引导 + 数据清洗”** 的三重防御策略。

## 1. Prompt 增强 (Few-Shot 引导)
在 `ChinesePrompts` 中增加明确的 **Few-Shot（少样本）示例**。不仅仅告诉它“要做什么”，还要给出“正确的例子”，让模型有样学样。

## 2. 核心逻辑重构：关闭自动广播，实施手动“安检”
目前的 `MsgHub` 开启了 `enable_auto_broadcast=True`，这意味着 Agent 生成的任何垃圾内容（包括幻觉代码）会立即自动分发给所有其他 Agent，瞬间污染全场记忆。

我将：
1.  **关闭自动广播**：将 `werewolf_phase` 和 `day_phase` 中的 `MsgHub` 设置为 `enable_auto_broadcast=False`。
2.  **增加“安检门”**：在 Agent 生成消息后，**先进行校验**，合格后再手动调用 `hub.broadcast()` 分发给其他人。
3.  **坏消息拦截与重写**：如果检测到消息包含代码、链接、或者不是 JSON，直接将其**替换**为一条合法的、无害的默认游戏发言（如“（沉思中）...”），确保进入其他人记忆的永远是干净的数据。

## 3. 增加每轮 User Prompt 提示
不要让 Agent 仅仅基于历史发言。在每一轮调用 `await agent()` 时，传入一个明确的 User Prompt（如 `“请基于当前局势发言，必须输出JSON格式”`），强制将模型的注意力拉回当前任务。

## 具体修改文件
*   `framework-study/AgentScopeDemo/main.py`

## 执行步骤
1.  **修改 `ChinesePrompts`**：加入 JSON 输出的范例。
2.  **定义 `sanitize_msg` 函数**：用于检测并清洗消息内容。
3.  **重构 `werewolf_phase`**：
    *   关闭 `auto_broadcast`。
    *   循环中：`agent()` -> `sanitize_msg()` -> `hub.broadcast()`。
4.  **重构 `day_phase`**：同上。
